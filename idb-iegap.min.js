if(navigator.userAgent.indexOf("Trident/6.0")!==-1||navigator.userAgent.indexOf("Trident/7.0")!==-1)(function(e,t){function n(e,t){if(typeof t!=="object")t=t();Object.keys(t).forEach(function(n){e[n]=t[n]});return e}function r(e){return{from:function(t){e.prototype=Object.create(t.prototype);e.prototype.constructor=e;return{extend:function(r){n(e.prototype,typeof r!=="object"?r(t.prototype):r)}}}}}function i(e,t){if(typeof e==="object")Object.keys(t).forEach(function(r){var i=Object.getOwnPropertyDescriptor(e,r);var s=t[r](i);if(s.hasOwnProperty("value")&&s.writable!==false)s.writable=true;Object.defineProperty(e,r,n({configurable:true,enumerable:true},s))});else return t(e)}function s(e,n){if(e.hasOwnProperty(n))return e[n];if(!n)return e;if(typeof n!=="string"){var r=[];for(var i=0,o=n.length;i<o;++i){var u=s(e,n[i]);r.push(u)}return r}var a=n.indexOf(".");if(a!==-1){var f=e[n.substr(0,a)];return f===t?t:s(f,n.substr(a+1))}return t}function o(e,n,r){if(!e||n===t)return;if(Array.isArray(n)){for(var i=0,s=n.length;i<s;++i){o(e,n[i],r[i])}}else{var u=n.indexOf(".");if(u!==-1){var a=n.substr(0,u);var f=n.substr(u+1);if(f==="")if(r===t)delete e[a];else e[a]=r;else{var l=e[a];if(!l)l=e[a]={};o(l,f,r)}}else{if(r===t)delete e[n];else e[n]=r}}}function u(e,n){o(e,n,t)}function a(e,t){return function(n){console.log("Warning: IEGap polyfill failed to "+(e.call?e():e)+": "+n.target.error);n.stopPropagation();n.preventDefault();t();return false}}function f(e,n,r,i,o,u){try{var f=s(r,n.keyPath);if(f===t)return u();var l=e.add({fk:i,k:w(f)});l.onerror=a("add compound index",u);l.onsuccess=function(t){if(o)o.push({store:e,del:true,pk:t.target.result});u()}}catch(c){console.log("IEGap polyfill exception when adding compound index key");u()}}function l(e,n,r,i,o,u){try{var f=s(r,n.keyPath);if(f===t)return u();if(!Array.isArray(f)){var l=e.add({fk:i,k:f});l.onerror=a("add index",u);l.onsuccess=function(t){if(o)o.push({store:e,del:true,pk:t.target.result});u()}}else{f.forEach(function(t){var r=e.add({fk:i,k:t});r.onerror=a(function(){return"add multiEntry index "+t+" for "+n.storeName+"."+n.keyPath},h);r.onsuccess=function(t){if(o)o.push({store:e,del:true,pk:t.target.result});h()}});var c=f.length;function h(){if(--c===0)u()}}}catch(p){console.log("IEGap polyfill exception when adding multientry key")}}function c(e,t,n){function s(){function s(){if(--r===0)n()}var t=e.objectStore;i.forEach(function(e){var n=t.delete(e);n.onerror=a("delete meta index",s);n.onsuccess=s});var r=i.length;if(r===0)n()}var r=e.openKeyCursor(t);var i=[];r.onerror=a("list indexed references",n);r.onsuccess=function(e){var t=r.result;if(!t)return s();i.push(t.primaryKey);t.continue()}}function h(e,t,n){function i(){if(--r===0&&t)t()}var r=e.length;e.forEach(function(e){var t=e.del?e.store.delete(e.pk):e.pk?e.store.add(e.obj,e.pk):e.store.add(e.obj);t.onerror=a(n||"executing bulk",i);t.onsuccess=i})}function g(){for(var e=4;e>=-4;--e){p[e]=Math.pow(32768,e)}}function y(e,t,n){var r=t-1,i=e<0?32767:0,s=e<0?-e:e,o="";while(r>=-n){var u=s/p[r]&32767^i;var a=u<<1|1;o+=String.fromCharCode(a);--r}return o}function b(e,n,r,i){var s=0,o=n-1,u=e.length;if(n+r!=u)return t;for(var a=0;a<u;++a){var f=e.charCodeAt(a)-1>>1;if(i)s-=p[o]*(f^32767);else s+=p[o]*f;--o}return s}function w(e){var t=e.length,n=new Array(t);for(var r=0;r<t;++r){var i=e[r];if(i instanceof Date)n[r]="D"+y(i.getTime(),4,0);else if(typeof i==="string")n[r]="S"+i;else if(isNaN(i))if(i)n[r]="J"+JSON.stringify(i);else if(typeof i==="undefined")n[r]="u";else n[r]="0";else n[r]=(i<0?"N":"n")+y(i,5,4)}return JSON.stringify(n)}function E(e){var n=JSON.parse(e),r=n.length,i=new Array(r);for(var s=0;s<r;++s){var o=n[s];var u=o[0];var a=o.substr(1);var f=t;if(u==="D")f=new Date(b(a,4,0));else if(u==="J")f=JSON.parse(a);else if(u==="S")f=a;else if(u==="N")f=b(a,5,4,true);else if(u==="n")f=b(a,5,4,false);else if(u==="u")f=t;else if(u==="0")f=null;i[s]=f}return i}function S(e){return e._iegapmeta}function x(e,t,n){e._iegapmeta=n;t.objectStore("$iegapmeta").put(n,1)}function T(e){if(Array.isArray(e))return w(e);if(e instanceof O)return d.bound(Array.isArray(e.lower)?w(e.lower):e.lower,Array.isArray(e.upper)?w(e.upper):e.upper,!!e.lowerOpen,!!e.upperOpen);return e}function N(e,t,n,r,i){this._idx=e;this._store=t;this._compound=Array.isArray(r);this._multiEntry=i;this.keyPath=r;this.name=n;this.objectStore=t;this.unique=e.unique}function C(e,t,n,r,i,s){this._cursor=e;this._store=n;this.direction=e.direction;this.key=i;this.primaryKey=r;this.source=t;if(arguments.length>=6)this.value=s}function k(){this._el={}}function L(e,t,n){this._el={};this.source=e;this.transaction=t;var r=this;var i={get:function(){return r}};n(function(e,t){r.result=t;Object.defineProperty(e,"target",i);r.dispatchEvent(e)},function(e,t){r.error=t||e.target.error;Object.defineProperty(e,"target",i);if(e.type!="error"){Object.defineProperty(e,"type",{get:function(){return"error"}})}r.dispatchEvent(e)},this)}function A(){L.apply(this,arguments)}function O(e,t,n,r){this.lower=e;this.upper=t;this.lowerOpen=n;this.upperOpen=r}function M(e){Object.defineProperties(e,{contains:{configurable:true,writable:true,value:function(t){return e.indexOf(t)!==-1}},item:{configurable:true,writable:true,value:function(t){return e[t]}}});return e}function _(){var t=Object.getOwnPropertyDescriptor(m.prototype,"objectStoreNames").get;var n=m.prototype.deleteObjectStore;var r=m.prototype.createObjectStore;g();e.open=i(e.open,function(e){return function(n,i){var s=e.apply(this,arguments);return new A(this,null,function(e,n,i){s.onerror=n;s.onblocked=i.dispatchEvent;s.onupgradeneeded=function(e){i.transaction=s.transaction;var n=i.result=s.result;n._upgradeTransaction=s.transaction;n._iegapmeta={stores:{}};if(!t.apply(n).contains("$iegapmeta")){var o=r.call(n,"$iegapmeta");o.add(n._iegapmeta,1)}e.target=e.currentTarget=i;i.dispatchEvent(e)};s.onsuccess=function(t){var r=s.result;delete r._upgradeTransaction;r._iegapmeta={stores:{}};try{var i=r.transaction(["$iegapmeta"],"readonly");var o=i.objectStore("$iegapmeta").get(1);o.onerror=n;o.onsuccess=function(){r._iegapmeta=o.result;e(t,r)}}catch(u){n(t,u)}}})}});d.bound=i(d.bound,function(e){return function(n,r,i,s){if(!Array.isArray(n))return e.apply(this,arguments);return new O(n,r,i,s)}});d.lowerBound=i(d.lowerBound,function(e){return function(n,r){if(!Array.isArray(n))return e.apply(this,arguments);return new O(n,null,r,null)}});d.upperBound=i(d.upperBound,function(e){return function(n,r){if(!Array.isArray(n))return e.apply(this,arguments);return new O(null,n,null,r)}});d.only=i(d.only,function(e){return function(n){if(!Array.isArray(n))return e.apply(this,arguments);return new O(n,n)}});v.prototype.count=i(v.prototype.count,function(e){return function(t){if(arguments.length>0)arguments[0]=T(t);return e.apply(this,arguments)}});v.prototype.get=i(v.prototype.get,function(e){return function(t){if(arguments.length>0)arguments[0]=T(t);return e.apply(this,arguments)}});v.prototype.openCursor=i(v.prototype.openCursor,function(e){return function(t,n){var r=this.transaction.db._iegapmeta.stores[this.name];if(!r||!r.compound)return e.apply(this,arguments);if(Array.isArray(t))t=new O(t,t);if(t&&!(t instanceof O))throw new RangeError("Primary key is compound but given range is not.");var i=t?d.bound(w(t.lower),w(t.upper),t.lowerOpen,t.upperOpen):t;var s=e.call(this,i,n);var o=this;return new L(this,this.transaction,function(e,t){s.onerror=t;s.onsuccess=function(t){var n=t.target.result;var r=E(n.key);if(n){var i=new C(n,o,o,r,r,n.value);e(t,i)}else{e(t,null)}}})}});v.prototype.createIndex=i(v.prototype.createIndex,function(e){function t(e,t,n,i){var s=e.transaction.db;var o="$iegap-"+e.name+"-"+t;var u=s._iegapmeta;if(i.multiEntry&&Array.isArray(n)){r.call(s,"dummy",{keyPath:"",autoIncrement:true});throw"invalid access"}var a=r.call(s,o,{autoIncrement:true});var f=u.stores[e.name]||(u.stores[e.name]={indexes:{},metaStores:[]});f.indexes[t]={name:t,keyPath:n,multiEntry:i.multiEntry||false,unique:i.unique||false,compound:Array.isArray(n),storeName:e.name,idxStoreName:o};f.metaStores.push(o);a.createIndex("fk","fk",{unique:false});var l=a.createIndex("k","k",{unique:i.unique||false});x(s,e.transaction,u);return new N(l,e,t,n,i.multiEntry)}return function(n,r,i){if(Array.isArray(r)||i&&i.multiEntry)return t(this,n,r,i||{});return e.apply(this,arguments)}});v.prototype.deleteIndex=i(v.prototype.deleteIndex,function(e){return function(t){var r=this.transaction.db;var i=r._iegapmeta;var s=i.stores[this.name];if(!s)return e.apply(this,arguments);var o=s.indexes[t];if(!o)return e.apply(this,arguments);n.call(r,o.idxStoreName);delete s.indexes[t];x(r,this.transaction,i)}});v.prototype.index=i(v.prototype.index,function(e){return function(t){var n=this.transaction.db._iegapmeta.stores[this.name];if(!n)return e.apply(this,arguments);var r=n.indexes[t];return r?new N(this.transaction.objectStore(r.idxStoreName).index("k"),this,r.name,r.keyPath,r.multiEntry):e.apply(this,arguments)}});v.prototype.add=i(v.prototype.add,function(e){return function(t,n){var r=this.transaction.db._iegapmeta.stores[this.name];if(!r)return e.apply(this,arguments);var i;if(r.compound){if(n)return this.add(null);n=w(s(t,r.keyPath));i=e.call(this,t,n)}else{i=e.apply(this,arguments)}var o=Object.keys(r.indexes);if(o.length===0)return i;var u=this;return new L(this,this.transaction,function(e,a){function g(){if(d&&(c||p))if(p){var t=false;p.preventDefault=function(){t=true};a(p);if(!t)u.transaction.abort()}else e(c,r.compound?E(i.result):i.result)}function y(){function n(){if(--e===0){if(!p){d=true;g()}else{h(v,function(){d=true;g()},"rolling back index additions")}}}var e=o.length;o.forEach(function(e){var i=r.indexes[e];var s=u.transaction.objectStore(i.idxStoreName);if(i.multiEntry){l(s,i,t,m,v,n)}else if(i.compound){f(s,i,t,m,v,n)}else{throw"IEGap assert error"}})}var c=null,p=null,d=false,v=[];var m=n||u.keyPath&&s(t,u.keyPath);if(!m){i.onerror=a;i.onsuccess=function(e){c=e;m=i.result;y()}}else{y();i.onerror=function(e){p=e;e.preventDefault();g()};i.onsuccess=function(e){c=e;g()}}})}});v.prototype.put=i(v.prototype.put,function(e){return function(t,n){var r=this.transaction.db._iegapmeta.stores[this.name];if(!r)return e.apply(this,arguments);var i;if(r.compound){if(n)return this.add(null);n=w(s(t,r.keyPath));i=e.call(this,t,n)}else{i=e.apply(this,arguments)}var o=Object.keys(r.indexes);if(o.length===0)return i;var u=this;return new L(this,this.transaction,function(e,n){function h(){function i(){if(--n===0)e(s,r.compound?E(a):a)}var n=o.length*2;o.forEach(function(e){var n=r.indexes[e];var s=u.transaction.objectStore(n.idxStoreName);c(s.index("fk"),a,i);if(n.multiEntry){l(s,n,t,a,null,i)}else if(n.compound){f(s,n,t,a,null,i)}else{throw"IEGap assert error"}})}var s=null;var a;i.onerror=n;i.onsuccess=function(e){s=e;a=i.result;h()}})}});v.prototype.delete=i(v.prototype.delete,function(e){return function(t){var n=this.transaction.db._iegapmeta.stores[this.name];if(!n)return e.apply(this,arguments);if(n.compound){t=w(t)}var r=e.call(this,t);var i=Object.keys(n.indexes);if(i.length==0)return r;var s=this;return new L(this,this.transaction,function(e,o){function a(){function o(){if(--r===0)e(u)}var r=i.length;i.forEach(function(e){var r=n.indexes[e];var i=s.transaction.objectStore(r.idxStoreName);c(i.index("fk"),t,o)})}var u=null;r.onerror=o;r.onsuccess=function(e){u=e;a()}})}});v.prototype.clear=i(v.prototype.clear,function(e){return function(){var t=e.apply(this,arguments);var n=this.transaction.db._iegapmeta.stores[this.name];if(!n)return t;var r=this;return new L(this,this.transaction,function(e,i){function u(){function i(){if(--t===0)e(o)}var t=s.length;if(t===0)return e(o);s.forEach(function(e){var t=n.indexes[e];var s=r.transaction.objectStore(t.idxStoreName);var o=s.clear();o.onerror=a("clearing meta store",i);o.onsuccess=i})}var s=Object.keys(n.indexes);var o=null;t.onerror=i;t.onsuccess=function(e){o=e;u()}})}});i(v.prototype,{indexNames:function(e){return{get:function(){var t=[].slice.call(e.get.apply(this));var n=this.transaction.db._iegapmeta.stores[this.name];if(n)t=t.concat(Object.keys(n.indexes));return new M(t)}}},autoIncrement:function(e){return{get:function(){var t=this.transaction.db._iegapmeta.stores[this.name];return t?t.autoIncrement:e.get.call(this)}}},keyPath:function(e){return{get:function(){var t=this.transaction.db._iegapmeta.stores[this.name];return t?t.keyPath:e.get.call(this)}}}});i(m.prototype,{transaction:function(e){return{value:function(t,n){t=typeof t=="string"?[t]:[].slice.call(t);var r=this._iegapmeta.stores;t.forEach(function(e){var n=r[e];if(n)t=t.concat(n.metaStores)});return e.value.call(this,t,n||"readonly")}}},objectStoreNames:function(e){return{get:function(){return new M([].slice.call(e.get.apply(this)).filter(function(e){return e.indexOf("$iegap")!==0}))}}},createObjectStore:function(e){return{value:function(t,n){var r,i=false;if(!n||!Array.isArray(n.keyPath)){r=e.value.apply(this,arguments)}else{i=true;if(n.autoIncrement)throw new RangeError("Cannot autoincrement compound key");r=e.value.call(this,t)}var s=this._iegapmeta;var o=s.stores[t]||(s.stores[t]={indexes:{},metaStores:[]});o.keyPath=n&&n.keyPath||null;o.compound=i;o.autoIncrement=n&&n.autoIncrement||false;x(this,r.transaction,s);return r}}},deleteObjectStore:function(e){return{value:function(t){e.value.call(this,t);var n=this._iegapmeta;var r=n.stores[t];if(!r)return;r.metaStores.forEach(function(t){e.value.call(this,t)});delete n.stores[t];if(!this._upgradeTransaction)throw"assert error";x(this,this._upgradeTransaction,n)}}}})}var p={};var d=window.IDBKeyRange,v=window.IDBObjectStore,m=window.IDBDatabase;r(N).from(Object).extend(function(){function e(e,t,n,r){return new L(e,e.objectStore.transaction,function(i,s){var o=e._compound,u=Array.isArray(e.objectStore.keyPath);if(o&&Array.isArray(t))t=new O(t,t);var a=o&&t?d.bound(w(t.lower),w(t.upper),t.lowerOpen,t.upperOpen):t;var f=e._idx.openCursor(a,n);f.onerror=s;if(r){f.onsuccess=function(t){var n=t.target.result;if(n){var r=e._store.get(n.value.fk);r.onerror=s;r.onsuccess=function(){if(!r.result)return n.continue();var s=o?E(n.key):n.key;var a=u?E(n.value.fk):n.value.fk;i(t,new C(n,e,e.objectStore,a,s,r.result))}}else{i(t,null)}}}else{f.onsuccess=function(t){var n=t.target.result;var r=o?E(n.key):n.key;var s=u?E(n.value.fk):n.value.fk;i(t,n&&new C(n,e,e.objectStore,s,r))}}})}return{count:function(e){if(arguments.length>0)arguments[0]=T(e);return this._idx.count.apply(this._idx,arguments)},get:function(e){var t=this;var n=this._idx.get(T(e));return new L(this,this.objectStore.transaction,function(e,r){n.onsuccess=function(i){var s=n.result&&n.result.fk;if(s){n=t.objectStore.get(s);n.onsuccess=function(){e(i,n.result)};n.onerror=r}else{e(i)}};n.onerror=r})},getKey:function(e){var t=this;var n=this._idx.get(T(e));return new L(this,this.objectStore.transaction,function(e,t){n.onsuccess=function(t){var n=t.target.result;e(t,n&&n.fk)};n.onerror=t})},openKeyCursor:function(t,n){return e(this,t,n)},openCursor:function(t,n){return e(this,t,n,true)}}});n(C.prototype,function(){return{advance:function(e){this._cursor.advance(e)},"continue":function(e){if(!e)return this._cursor.continue();if(Array.isArray(e))return this._cursor.continue(w(e));return this._cursor.continue(e)},"delete":function(){return this._store.delete(this.primaryKey)},update:function(e){return this._store.put(this.primaryKey,e)}}});n(k.prototype,function(){return{addEventListener:function(e,t){this._el[e]?this._el[e].push(t):this._el[e]=[t]},removeEventListener:function(e,t){var n=this._el[e];if(n){var r=n.indexOf(t);if(r!==-1)n.splice(r,1)}},dispatchEvent:function(e){var t=this["on"+e.type];if(t&&t(e)===false)return false;var n=this._el[e.type];if(n){for(var r=0,i=n.length;r<i;++r){t=n[r];if((t.handleEvent||t)(e)===false)return false}return true}}}});r(L).from(k).extend({onsuccess:null,onerror:null});r(A).from(L).extend({onblocked:null,onupgradeneeded:null});_()})(window.indexedDB||window.msIndexedDB)
